<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Confirma√ß√µes</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg: #08080c;
      --surface: #0f0f14;
      --surface2: #16161d;
      --surface3: #1c1c26;
      --border: #2a2a3a;
      --border-active: #3a3a4f;
      --text: #f0f0f5;
      --text-m: #a0a0b0;
      --text-d: #606070;
      --accent: #a78bfa;
      --accent-glow: rgba(167,139,250,0.15);
      --green: #4ade80;
      --green-soft: rgba(74,222,128,0.12);
      --red: #f87171;
      --red-soft: rgba(248,113,113,0.12);
      --yellow: #fbbf24;
      --yellow-soft: rgba(251,191,36,0.12);
      --blue: #60a5fa;
      --blue-soft: rgba(96,165,250,0.12);
    }

    [data-theme="light"] {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --surface2: #f0f0f2;
      --surface3: #e8e8ec;
      --border: #d0d0d8;
      --border-active: #b0b0b8;
      --text: #1a1a1f;
      --text-m: #505060;
      --text-d: #808090;
      --accent: #7c3aed;
      --accent-glow: rgba(124,58,237,0.15);
      --green: #22c55e;
      --green-soft: rgba(34,197,94,0.15);
      --red: #ef4444;
      --red-soft: rgba(239,68,68,0.15);
      --yellow: #f59e0b;
      --yellow-soft: rgba(245,158,11,0.15);
      --blue: #3b82f6;
      --blue-soft: rgba(59,130,246,0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(167,139,250,0.06) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
      transition: opacity 0.3s;
    }

    [data-theme="light"] body::before {
      opacity: 0.5;
    }

    [data-theme="light"] .period-inputs input[type="date"]::-webkit-calendar-picker-indicator {
      filter: none;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .header h1 span { color: var(--accent); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header .meta {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-d);
      text-align: right;
    }

    .theme-toggle {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 20px;
    }

    .theme-toggle:hover {
      background: var(--surface3);
      border-color: var(--accent);
      transform: scale(1.05);
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--green-soft);
      color: var(--green);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .live-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Connection Bar */
    .conn-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 28px;
    }

    .conn-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-m);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conn-bar {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .conn-bar input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }

    .conn-bar input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .conn-bar input::placeholder { color: var(--text-d); }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(167,139,250,0.3);
    }

    .btn-secondary {
      background: var(--surface3);
      color: var(--text-m);
    }

    .btn-secondary:hover {
      background: var(--border);
      color: var(--text);
    }

    .conn-help {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-d);
    }

    .conn-help code {
      background: var(--surface2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-active);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }

    .stat-card.green::before { background: var(--green); }
    .stat-card.red::before { background: var(--red); }
    .stat-card.yellow::before { background: var(--yellow); }
    .stat-card.blue::before { background: var(--blue); }
    .stat-card.purple::before { background: var(--accent); }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 4px;
    }

    .stat-card.green .stat-value { color: var(--green); }
    .stat-card.red .stat-value { color: var(--red); }
    .stat-card.yellow .stat-value { color: var(--yellow); }
    .stat-card.blue .stat-value { color: var(--blue); }
    .stat-card.purple .stat-value { color: var(--accent); }

    .stat-label {
      font-size: 12px;
      color: var(--text-d);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .stat-pct {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stat-card.green .stat-pct { background: var(--green-soft); color: var(--green); }
    .stat-card.red .stat-pct { background: var(--red-soft); color: var(--red); }
    .stat-card.yellow .stat-pct { background: var(--yellow-soft); color: var(--yellow); }

    /* Section */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-d);
      margin-bottom: 20px;
      font-weight: 600;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }

    .chart-box {
      background: var(--surface2);
      border-radius: 12px;
      padding: 20px;
    }

    .chart-box h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-m);
    }

    .chart-container {
      height: 280px;
      position: relative;
    }

    /* Brand Filter */
    .brand-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .brand-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: transparent;
      color: var(--text-m);
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .brand-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .brand-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    /* Period Filter */
    .period-filter {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .period-label, .brand-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-m);
    }

    .brand-label {
      margin-bottom: 10px;
    }

    .period-inputs {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .period-inputs input[type="date"] {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }

    .period-inputs input[type="date"]:focus {
      border-color: var(--accent);
    }

    .period-inputs input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
      cursor: pointer;
    }

    .period-inputs span {
      color: var(--text-d);
      font-size: 13px;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 12px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-d);
      font-weight: 600;
      background: var(--surface2);
    }

    tr:hover td {
      background: var(--surface2);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.green { background: var(--green-soft); color: var(--green); }
    .status-badge.red { background: var(--red-soft); color: var(--red); }
    .status-badge.yellow { background: var(--yellow-soft); color: var(--yellow); }

    /* Loading */
    .loading {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 13px;
      color: var(--text-m);
      z-index: 100;
      animation: fadeIn 0.3s;
    }

    .loading.active { display: flex; align-items: center; gap: 10px; }

    .loading::before {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-d);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 18px;
      color: var(--text-m);
      margin-bottom: 8px;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 12px;
      color: var(--text-d);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .charts-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 22px; }
      .stat-value { font-size: 26px; }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">Carregando dados...</div>

  <div class="app">
    <header class="header">
      <div>
        <h1>üì¶ Dashboard <span>Confirma√ß√µes</span></h1>
      </div>
      <div class="header-right">
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Alternar tema">
          <span class="theme-icon" id="themeIcon">üåô</span>
        </button>
        <div class="meta">
          <div class="live-badge" id="statusBadge" style="display: none;">LIVE</div>
          <div id="lastUpdate"></div>
        </div>
      </div>
    </header>

    <!-- Conex√£o -->
    <div class="conn-section">
      <h3>üîó Conectar Google Sheets</h3>
      <div class="conn-bar">
        <input type="text" id="sheetUrl" placeholder="Cole o link do CSV publicado do Google Sheets...">
        <button class="btn btn-primary" onclick="connectSheet()">Conectar</button>
        <button class="btn btn-secondary" id="btnRefresh" onclick="fetchData()" style="display: none;">‚Üª Atualizar</button>
      </div>
      <div class="conn-help">
        <strong>Como publicar:</strong> No Google Sheets, v√° em <code>Arquivo ‚Üí Compartilhar ‚Üí Publicar na web</code> ‚Üí escolha <code>CSV</code> ‚Üí copie o link
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card purple">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total Registros</div>
      </div>
      <div class="stat-card green">
        <div class="stat-value" id="statReconheco">0</div>
        <div class="stat-label">‚úÖ Reconhe√ßo</div>
        <div class="stat-pct" id="pctReconheco">0%</div>
      </div>
      <div class="stat-card red">
        <div class="stat-value" id="statNaoReconheco">0</div>
        <div class="stat-label">‚ùå N√£o Reconhe√ßo</div>
        <div class="stat-pct" id="pctNaoReconheco">0%</div>
      </div>
      <div class="stat-card yellow">
        <div class="stat-value" id="statInvestigacao">0</div>
        <div class="stat-label">üîç Investiga√ß√£o</div>
        <div class="stat-pct" id="pctInvestigacao">0%</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="section">
      <div class="section-title">Filtros</div>
      
      <!-- Period Filter -->
      <div class="period-filter">
        <div class="period-label">üìÖ Per√≠odo:</div>
        <div class="period-inputs">
          <input type="date" id="dateStart" onchange="applyFilters()">
          <span>at√©</span>
          <input type="date" id="dateEnd" onchange="applyFilters()">
          <button class="btn btn-secondary btn-sm" onclick="clearPeriod()">Limpar</button>
          <button class="btn btn-secondary btn-sm" onclick="setPeriod('today')">Hoje</button>
          <button class="btn btn-secondary btn-sm" onclick="setPeriod('week')">7 dias</button>
          <button class="btn btn-secondary btn-sm" onclick="setPeriod('month')">30 dias</button>
        </div>
      </div>
      
      <!-- Brand Filter -->
      <div class="brand-label">üè∑Ô∏è Marca:</div>
      <div class="brand-filter" id="brandFilter"></div>
    </div>

    <!-- Charts -->
    <div class="section">
      <div class="section-title">Visualiza√ß√µes</div>
      <div class="charts-grid">
        <div class="chart-box">
          <h4>Distribui√ß√£o Geral</h4>
          <div class="chart-container"><canvas id="chartDonut"></canvas></div>
        </div>
        <div class="chart-box">
          <h4>Taxa por Marca</h4>
          <div class="chart-container"><canvas id="chartBar"></canvas></div>
        </div>
        <div class="chart-box">
          <h4>Evolu√ß√£o Di√°ria</h4>
          <div class="chart-container"><canvas id="chartLine"></canvas></div>
        </div>
        <div class="chart-box">
          <h4>Propor√ß√£o por Marca</h4>
          <div class="chart-container"><canvas id="chartStacked"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="section">
      <div class="section-title">√öltimos Registros</div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Marca</th>
              <th>Status</th>
              <th>Pedido</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="empty-state" id="emptyState">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3>Nenhum dado carregado</h3>
        <p>Conecte um Google Sheets para visualizar os dados</p>
      </div>
    </div>

    <div class="footer">
      Atualiza√ß√£o autom√°tica a cada 5 minutos ¬∑ Dashboard de Confirma√ß√µes de Entrega
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // THEME TOGGLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('dashboard_theme', newTheme);
      
      updateThemeIcon(newTheme);
      
      // Re-renderizar gr√°ficos com novas cores
      if (allData.length > 0) {
        render();
      }
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      icon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    }

    function loadSavedTheme() {
      const saved = localStorage.getItem('dashboard_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let allData = [];
    let filteredData = [];
    let currentBrand = 'all';
    let dateStart = null;
    let dateEnd = null;
    let charts = {};
    let refreshInterval = null;

    const BRAND_COLORS = {};
    const COLOR_POOL = ['#a78bfa','#f472b6','#fb923c','#4ade80','#60a5fa','#fbbf24','#f87171','#34d399','#e879f9','#38bdf8'];
    let colorIndex = 0;

    function getBrandColor(name) {
      if (!BRAND_COLORS[name]) {
        BRAND_COLORS[name] = COLOR_POOL[colorIndex % COLOR_POOL.length];
        colorIndex++;
      }
      return BRAND_COLORS[name];
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DATE HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function parseDate(dateStr) {
      if (!dateStr) return null;
      // Formato: dd/mm/yyyy
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      return null;
    }

    function formatDateISO(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function setPeriod(preset) {
      const today = new Date();
      let start = new Date();
      
      switch(preset) {
        case 'today':
          start = today;
          break;
        case 'week':
          start.setDate(today.getDate() - 7);
          break;
        case 'month':
          start.setDate(today.getDate() - 30);
          break;
      }
      
      document.getElementById('dateStart').value = formatDateISO(start);
      document.getElementById('dateEnd').value = formatDateISO(today);
      applyFilters();
    }

    function clearPeriod() {
      document.getElementById('dateStart').value = '';
      document.getElementById('dateEnd').value = '';
      applyFilters();
    }

    function applyFilters() {
      const startVal = document.getElementById('dateStart').value;
      const endVal = document.getElementById('dateEnd').value;
      
      dateStart = startVal ? new Date(startVal + 'T00:00:00') : null;
      dateEnd = endVal ? new Date(endVal + 'T23:59:59') : null;
      
      filterData();
    }

    function filterData() {
      filteredData = allData.filter(d => {
        // Filtro por marca
        if (currentBrand !== 'all' && d.marca !== currentBrand) return false;
        
        // Filtro por per√≠odo
        if (dateStart || dateEnd) {
          const rowDate = parseDate(d.data);
          if (!rowDate) return false;
          if (dateStart && rowDate < dateStart) return false;
          if (dateEnd && rowDate > dateEnd) return false;
        }
        
        return true;
      });
      
      render();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4L_fzPoWVlqnVqWaskUO4NNOmQ3i3UNM1ZyZVY6ZbmmrxI5DYvVrsnrOpXJrXzUORr4of86mBRATf/pub?gid=0&single=true&output=csv';

    window.addEventListener('DOMContentLoaded', () => {
      // Carrega tema salvo
      loadSavedTheme();
      
      // Usa URL salva ou a padr√£o embutida
      const saved = localStorage.getItem('dashboard_sheet_url') || DEFAULT_SHEET_URL;
      document.getElementById('sheetUrl').value = saved;
      connectSheet();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONNECTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function connectSheet() {
      const url = document.getElementById('sheetUrl').value.trim();
      if (!url) return;
      
      localStorage.setItem('dashboard_sheet_url', url);
      document.getElementById('btnRefresh').style.display = '';
      
      fetchData();
      
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(fetchData, 5 * 60 * 1000); // 5 minutos
    }

    function fetchData() {
      const url = localStorage.getItem('dashboard_sheet_url') || DEFAULT_SHEET_URL;
      if (!url) return;

      document.getElementById('loading').classList.add('active');

      // Tenta direto primeiro, se falhar usa proxy
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          document.getElementById('loading').classList.remove('active');
          document.getElementById('statusBadge').style.display = 'flex';
          document.getElementById('emptyState').style.display = 'none';
          
          allData = normalizeData(results.data);
          
          renderBrandFilter();
          filterData();
          
          document.getElementById('lastUpdate').textContent = 
            'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');
        },
        error: function(err) {
          // Se falhar por CORS, tenta com proxy
          const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
          
          Papa.parse(proxyUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              document.getElementById('loading').classList.remove('active');
              document.getElementById('statusBadge').style.display = 'flex';
              document.getElementById('emptyState').style.display = 'none';
              
              allData = normalizeData(results.data);
              
              renderBrandFilter();
              filterData();
              
              document.getElementById('lastUpdate').textContent = 
                'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');
            },
            error: function(err2) {
              document.getElementById('loading').classList.remove('active');
              console.error('Erro:', err2);
              alert('N√£o foi poss√≠vel carregar os dados. Tente novamente ou verifique se a planilha est√° publicada corretamente.');
            }
          });
        }
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NORMALIZE DATA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function normalizeData(data) {
      return data.map(row => {
        const normalized = {};
        
        Object.keys(row).forEach(key => {
          const lowerKey = key.toLowerCase().trim();
          if (lowerKey.includes('data')) normalized.data = row[key];
          else if (lowerKey.includes('confirma')) normalized.confirmacao = row[key];
          else if (lowerKey.includes('marca')) normalized.marca = row[key];
          else if (lowerKey.includes('pedido') || lowerKey.includes('order')) normalized.pedido = row[key];
        });
        
        return normalized;
      }).filter(row => row.confirmacao);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CLASSIFY STATUS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getStatus(confirmacao) {
      if (!confirmacao) return 'unknown';
      const c = confirmacao.toLowerCase();
      
      // ‚úÖ Reconhe√ßo (inclui "Sim, reconhe√ßo" e "Encontrei, est√° tudo certo")
      if (c.includes('sim, reconhe√ßo') || c.includes('sim reconhe√ßo') || 
          c.includes('encontrei') || c.includes('tudo certo') ||
          (c.includes('reconhe√ßo') && !c.includes('n√£o'))) {
        return 'reconheco';
      }
      
      // ‚ùå N√£o reconhe√ßo
      if (c.includes('n√£o reconhe√ßo') || c.includes('nao reconheco')) {
        return 'nao-reconheco';
      }
      
      // üîç Investiga√ß√£o
      if (c.includes('investiga√ß√£o') || c.includes('investigacao')) {
        return 'investigacao';
      }
      
      return 'unknown';
    }

    function getStatusLabel(status) {
      switch(status) {
        case 'reconheco': return '‚úÖ Reconhe√ßo';
        case 'nao-reconheco': return '‚ùå N√£o Reconhe√ßo';
        case 'investigacao': return 'üîç Investiga√ß√£o';
        default: return '‚ùì Desconhecido';
      }
    }

    function getStatusClass(status) {
      switch(status) {
        case 'reconheco': return 'green';
        case 'nao-reconheco': return 'red';
        case 'investigacao': return 'yellow';
        default: return '';
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BRAND FILTER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderBrandFilter() {
      const brands = [...new Set(allData.map(d => d.marca).filter(Boolean))];
      const container = document.getElementById('brandFilter');
      
      container.innerHTML = `
        <button class="brand-btn active" onclick="filterBrand('all')">üåê Todas</button>
        ${brands.map(b => `
          <button class="brand-btn" onclick="filterBrand('${b}')">${b}</button>
        `).join('')}
      `;
    }

    function filterBrand(brand) {
      currentBrand = brand;
      
      document.querySelectorAll('.brand-btn').forEach(btn => {
        btn.classList.toggle('active', 
          (brand === 'all' && btn.textContent.includes('Todas')) ||
          btn.textContent === brand
        );
      });
      
      filterData();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function render() {
      const stats = {
        total: filteredData.length,
        reconheco: filteredData.filter(d => getStatus(d.confirmacao) === 'reconheco').length,
        naoReconheco: filteredData.filter(d => getStatus(d.confirmacao) === 'nao-reconheco').length,
        investigacao: filteredData.filter(d => getStatus(d.confirmacao) === 'investigacao').length
      };

      // Stats
      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statReconheco').textContent = stats.reconheco;
      document.getElementById('statNaoReconheco').textContent = stats.naoReconheco;
      document.getElementById('statInvestigacao').textContent = stats.investigacao;
      
      const pctRec = stats.total ? ((stats.reconheco / stats.total) * 100).toFixed(1) : 0;
      const pctNao = stats.total ? ((stats.naoReconheco / stats.total) * 100).toFixed(1) : 0;
      const pctInv = stats.total ? ((stats.investigacao / stats.total) * 100).toFixed(1) : 0;
      
      document.getElementById('pctReconheco').textContent = pctRec + '%';
      document.getElementById('pctNaoReconheco').textContent = pctNao + '%';
      document.getElementById('pctInvestigacao').textContent = pctInv + '%';

      renderCharts(stats);
      renderTable();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CHARTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderCharts(stats) {
      // Destroy existing charts
      Object.values(charts).forEach(c => c && c.destroy());

      // Donut Chart
      charts.donut = new Chart(document.getElementById('chartDonut'), {
        type: 'doughnut',
        data: {
          labels: ['Reconhe√ßo', 'N√£o Reconhe√ßo', 'Investiga√ß√£o'],
          datasets: [{
            data: [stats.reconheco, stats.naoReconheco, stats.investigacao],
            backgroundColor: ['#4ade80', '#f87171', '#fbbf24'],
            borderWidth: 0,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#a0a0b0', padding: 16, usePointStyle: true, font: { size: 12 } }
            }
          }
        }
      });

      // Bar Chart - Por Marca
      const brands = {};
      allData.forEach(d => {
        const m = d.marca || 'Sem Marca';
        if (!brands[m]) brands[m] = { rec: 0, nrec: 0, inv: 0, total: 0 };
        brands[m].total++;
        const s = getStatus(d.confirmacao);
        if (s === 'reconheco') brands[m].rec++;
        else if (s === 'nao-reconheco') brands[m].nrec++;
        else if (s === 'investigacao') brands[m].inv++;
      });

      const brandNames = Object.keys(brands).filter(b => b !== 'Sem Marca' && b.trim());
      const taxas = brandNames.map(b => brands[b].total ? (brands[b].rec / brands[b].total * 100).toFixed(1) : 0);

      charts.bar = new Chart(document.getElementById('chartBar'), {
        type: 'bar',
        data: {
          labels: brandNames,
          datasets: [{
            label: 'Taxa Reconhecimento %',
            data: taxas,
            backgroundColor: brandNames.map(b => getBrandColor(b)),
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              max: 100,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            x: { 
              grid: { display: false },
              ticks: { color: '#606070' }
            }
          }
        }
      });

      // Line Chart - Evolu√ß√£o Di√°ria
      const daily = {};
      filteredData.forEach(d => {
        const data = d.data || 'Sem Data';
        if (!daily[data]) daily[data] = { rec: 0, nrec: 0, inv: 0 };
        const s = getStatus(d.confirmacao);
        if (s === 'reconheco') daily[data].rec++;
        else if (s === 'nao-reconheco') daily[data].nrec++;
        else if (s === 'investigacao') daily[data].inv++;
      });

      const sortedDates = Object.keys(daily).sort((a, b) => {
        const [dA, mA, yA] = a.split('/');
        const [dB, mB, yB] = b.split('/');
        return new Date(yA, mA-1, dA) - new Date(yB, mB-1, dB);
      }).slice(-14);

      charts.line = new Chart(document.getElementById('chartLine'), {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [
            {
              label: 'Reconhe√ßo',
              data: sortedDates.map(d => daily[d]?.rec || 0),
              borderColor: '#4ade80',
              backgroundColor: 'rgba(74,222,128,0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'N√£o Reconhe√ßo',
              data: sortedDates.map(d => daily[d]?.nrec || 0),
              borderColor: '#f87171',
              backgroundColor: 'rgba(248,113,113,0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Investiga√ß√£o',
              data: sortedDates.map(d => daily[d]?.inv || 0),
              borderColor: '#fbbf24',
              backgroundColor: 'rgba(251,191,36,0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#a0a0b0', padding: 12, usePointStyle: true }
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            x: { 
              grid: { display: false },
              ticks: { color: '#606070', maxRotation: 45 }
            }
          }
        }
      });

      // Stacked Bar - Propor√ß√£o por Marca
      charts.stacked = new Chart(document.getElementById('chartStacked'), {
        type: 'bar',
        data: {
          labels: brandNames,
          datasets: [
            {
              label: 'Reconhe√ßo',
              data: brandNames.map(b => brands[b].rec),
              backgroundColor: '#4ade80',
              borderRadius: 4
            },
            {
              label: 'N√£o Reconhe√ßo',
              data: brandNames.map(b => brands[b].nrec),
              backgroundColor: '#f87171',
              borderRadius: 4
            },
            {
              label: 'Investiga√ß√£o',
              data: brandNames.map(b => brands[b].inv),
              backgroundColor: '#fbbf24',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#a0a0b0', padding: 12, usePointStyle: true }
            }
          },
          scales: {
            y: { 
              stacked: true,
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            x: { 
              stacked: true,
              grid: { display: false },
              ticks: { color: '#606070' }
            }
          }
        }
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TABLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const rows = filteredData.slice(0, 30);
      
      tbody.innerHTML = rows.map(d => {
        const status = getStatus(d.confirmacao);
        return `
          <tr>
            <td>${d.data || '-'}</td>
            <td>${d.marca || '-'}</td>
            <td><span class="status-badge ${getStatusClass(status)}">${getStatusLabel(status)}</span></td>
            <td>${d.pedido || '-'}</td>
          </tr>
        `;
      }).join('');
    }
  </script>
</body>
</html>
